<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Отмена бронирования</title>
  <style>
    .form-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    #bookingForm {
      width: 100%;
      max-width: 500px;
      animation: fadeIn 1s ease forwards;
    }

    #bookingForm input {
      display: block;
      margin-bottom: 10px;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    #bookingForm button {
      display: block;
      margin: 0 auto;
      padding: 10px 20px;
      background: #FFD700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    #resultsTable {
      width: 100%;
      max-width: 800px;
      margin-top: 20px;
      border-collapse: collapse;
      display: none;
    }

    #resultsTable th,
    #resultsTable td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }

    #resultsTable th {
      background-color: #f9f9f9;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #FFD700;
      color: #333;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      display: none;
    }
  </style>
</head>

<body>

  <div class="form-container" id="bookingForm">
    <h3>Отмена бронирования</h3>
    <input type="text" id="cancelPhone" placeholder="Введите номер телефона">
    <input type="text" id="cancelBookingID" placeholder="ИЛИ введите ID бронирования">
    <button onclick="checkBooking()">Показать бронирования</button>
  </div>

  <table id="resultsTable">
    <thead>
      <tr>
        <th></th>
        <th>ID</th>
        <th>Даты</th>
        <th>Объект</th>
        <th>Сумма</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>

  <button id="cancelButton" onclick="cancelSelected()" style="display:none;">Отменить выбранные</button>

  <div class="toast" id="toast">Успешно отменено</div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx4VyynFK5ak_VZZ6E6o-XbQpV6jbtcEe3vU4hbAkE9fuJ8OB-s_hhwD5mImLCyY9GD/exec";

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.innerText = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }

    function normalizePhone(phone) {
      return phone.replace(/\D/g, '');
    }

    function checkBooking() {
      let phone = document.getElementById('cancelPhone').value.trim();
      const id = document.getElementById('cancelBookingID').value.trim();

      if (!phone && !id) {
        alert('Введите телефон или ID');
        return;
      }

      phone = normalizePhone(phone);
      window.handleJSONPResponse = handleJSONPResponse;

      let src = `${SCRIPT_URL}?type=check&callback=handleJSONPResponse`;
      if (id) {
        const bookingId = Number(id);
        if (isNaN(bookingId)) {
          alert('ID бронирования должен быть числом');
          return;
        }
        src += `&booking_id=${encodeURIComponent(bookingId)}`;
      } else {
        src += `&phone=${encodeURIComponent(phone)}`;
      }

      const oldScript = document.getElementById("jsonpScript");
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.src = src;
      script.id = "jsonpScript";
      document.body.appendChild(script);
    }

    function handleJSONPResponse(data) {
      const table = document.getElementById('resultsTable');
      const body = document.getElementById('resultsBody');
      const btn = document.getElementById('cancelButton');

      body.innerHTML = '';
      table.style.display = 'none';
      btn.style.display = 'none';

      const list = data.bookings || [];
      if (!list.length) {
        alert(data.error || 'Не найдено');
        return;
      }

      list.forEach(b => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" value="${b.booking_id}"></td>
          <td>${b.booking_id}</td>
          <td>${b.checkin} — ${b.checkout}</td>
          <td>${b.room || b.accommodation || ''}</td>
          <td>${b.total || b.price || 0}₽</td>
        `;
        body.appendChild(tr);
      });

      table.style.display = 'table';
      btn.style.display = 'inline-block';
    }

    function cancelSelected() {
      const checks = Array.from(document.querySelectorAll('#resultsBody input:checked'));
      if (!checks.length) {
        alert('Выберите хотя бы одно бронирование');
        return;
      }

      const ids = checks.map(ch => ch.value);
      window.handleCancelResponse = handleCancelResponse;

      const src = `${SCRIPT_URL}?action=cancel&booking_ids=${encodeURIComponent(JSON.stringify(ids))}&callback=handleCancelResponse`;

      const oldScript = document.getElementById("jsonpScript");
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.src = src;
      script.id = "jsonpScript";
      document.body.appendChild(script);
    }

    function handleCancelResponse(data) {
      if (data.success) {
        showToast(`Отменено: ${data.deleted.length}`);
        checkBooking();
      } else {
        alert(data.error || 'Ошибка при отмене');
      }
    }
  </script>

</body>

</html>
