<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Бронирование номера</title>
  <style>
    body {
      font-family: Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      padding: 30px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
    }
    h2 {
      text-align: center;
      color: #333;
    }
    label {
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #FFD700;
      border-radius: 8px;
      margin-top: 5px;
    }
    button {
      padding: 12px;
      background: #FFD700;
      color: #333;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background: #e6c200;
    }
    .toast {
      position: fixed; top: 20px; right: 20px;
      background: #FFD700; color: #333;
      padding: 12px 20px; border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 9999;
    }
    #manageForm { display: none; }
  </style>
</head>
<body>

<div class="container">
  <h2>Бронирование номера</h2>

  <!-- Основная форма бронирования -->
  <form id="bookingForm">
    <label>ФИО</label>
    <input type="text" id="full_name" required>

    <label>Телефон</label>
    <input type="tel" id="phone" required>

    <label>Email</label>
    <input type="email" id="email" required>

    <label>Количество гостей</label>
    <input type="number" id="guests" min="1" max="6" required>

    <label>Дата заезда</label>
    <input type="date" id="checkin" required>

    <label>Дата выезда</label>
    <input type="date" id="checkout" required>

    <label>Номер</label>
    <select id="room" disabled>
      <option>Сначала выберите даты</option>
    </select>

    <div id="total_price"></div>

    <label>Пожелания</label>
    <textarea id="comments"></textarea>

    <div>
      <input type="checkbox" id="agree" required>
      <label for="agree">Я согласен с условиями проживания</label>
    </div>

    <button type="submit" id="submitBtn" disabled>Забронировать</button>
    <button type="button" id="manageBtn">Управление бронированием</button>
  </form>

  <!-- Форма управления бронированием -->
  <div id="manageForm">
    <label>ID бронирования (например: N-12345678)</label>
    <input type="text" id="searchID">
    <button type="button" id="searchBtn">Найти</button>
  </div>

  <!-- Кнопка возврата -->
  <button id="newBookingBtn" style="display:none;">Новое бронирование</button>
</div>

<!-- Контейнер для тостов -->
<div id="toastContainer"></div>

<script>
const API = 'ВАШ_АДРЕС_АПИ'; // Замените на ваш Apps Script URL

function generateBookingID() {
  return 'N-' + Math.floor(Math.random() * 90000000 + 10000000);
}

function showToast(msg) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerText = msg;
  document.getElementById('toastContainer').appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

document.addEventListener('DOMContentLoaded', () => {
  const bookingForm = document.getElementById('bookingForm');
  const manageForm = document.getElementById('manageForm');
  const newBookingBtn = document.getElementById('newBookingBtn');

  // Управление формами
  document.getElementById('manageBtn').addEventListener('click', () => {
    bookingForm.style.display = 'none';
    manageForm.style.display = 'block';
    newBookingBtn.style.display = 'block';
  });

  newBookingBtn.addEventListener('click', () => {
    manageForm.style.display = 'none';
    bookingForm.style.display = 'block';
    newBookingBtn.style.display = 'none';
  });

  // Отправка формы бронирования
  bookingForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!document.getElementById('agree').checked) {
      showToast('Вы должны согласиться с условиями!');
      return;
    }

    const bookingID = generateBookingID();
    const data = {
      booking_id: bookingID,
      full_name: document.getElementById('full_name').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      guests: document.getElementById('guests').value,
      checkin: document.getElementById('checkin').value,
      checkout: document.getElementById('checkout').value,
      room_id: document.getElementById('room').value,
      comments: document.getElementById('comments').value,
      total_price: 1000 // Заглушка
    };

    fetch(API, {
      method: 'POST',
      body: JSON.stringify(data),
      mode: 'cors'
    })
    .then(r => r.json())
    .then(res => {
      if (res.result === 'success') {
        alert(`Бронирование успешно! Ваш ID: ${bookingID}`);
        bookingForm.reset();
        document.getElementById('submitBtn').disabled = true;
      } else {
        showToast('Ошибка бронирования!');
      }
    })
    .catch(() => showToast('Ошибка соединения'));
  });

  // Поиск бронирования
  document.getElementById('searchBtn').addEventListener('click', () => {
    const id = document.getElementById('searchID').value.trim();
    if (!id.startsWith('N-')) {
      showToast('Неверный формат ID');
      return;
    }

    fetch(`${API}?action=search&id=${encodeURIComponent(id)}`)
      .then(r => r.json())
      .then(res => {
        if (res.result === 'success' && res.booking) {
          const b = res.booking;
          const win = window.open('', '', 'width=600,height=500');
          win.document.write(`
            <h2>Бронирование ${b.booking_id}</h2>
            <p><strong>Имя:</strong> ${b.full_name}</p>
            <p><strong>Телефон:</strong> ${b.phone}</p>
            <p><strong>Дата:</strong> ${b.checkin} – ${b.checkout}</p>
            <p><strong>Номер:</strong> ${b.room_id}</p>
            <p><strong>Комментарий:</strong> ${b.comments}</p>
            <button onclick="window.opener.cancelBooking('${b.booking_id}', window)">Отменить бронирование</button>
            <button onclick="window.close()">Закрыть</button>
          `);
        } else {
          showToast('Бронирование не найдено');
        }
      });
  });
});

// Глобальная функция отмены бронирования
function cancelBooking(id, win) {
  fetch(`${API}?action=cancel&id=${encodeURIComponent(id)}`)
    .then(r => r.json())
    .then(res => {
      if (res.result === 'success') {
        alert('Бронирование успешно отменено!');
        win.close();
      } else {
        showToast('Не удалось отменить');
      }
    });
}
</script>
</body>
</html>
