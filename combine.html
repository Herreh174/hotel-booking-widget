<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Бронирование</title>
  <style>
    body {
      background: #f9f9f9;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
    }
    .form-group {
      margin-bottom: 15px;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #FFD700;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: #FFD700;
      color: #333;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    .loader {
      display: none;
      text-align: center;
      margin-top: 10px;
    }
    .toast {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 9999;
    }
    @media (max-width: 600px) {
      .container {
        margin: 20px 10px;
        padding: 20px;
      }
      button {
        font-size: 15px;
        padding: 12px;
      }
      input, select, textarea {
        font-size: 15px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<div class="container" id="bookingForm">
  <div style="text-align:right; margin-bottom:10px;">
    <button type="button" onclick="openManageForm()" style="background:#ccc;">
      Управление бронированием
    </button>
  </div>

  <h2 style="text-align:center;">Форма бронирования</h2>
  <form onsubmit="submitForm(event)">
    <div class="form-group">
      <input type="text" id="fullName" placeholder="ФИО" required>
    </div>
    <div class="form-group">
      <input type="tel" id="phone" placeholder="Телефон" required>
    </div>
    <div class="form-group">
      <input type="email" id="email" placeholder="Email" required>
    </div>
    <div class="form-group">
      <label>Дата заезда:</label>
      <input type="date" id="checkin" required>
    </div>
    <div class="form-group">
      <label>Дата выезда:</label>
      <input type="date" id="checkout" required>
    </div>
    <div class="form-group">
      <input type="number" id="guests" placeholder="Количество гостей" required>
    </div>
    <div class="form-group">
      <select id="room_type" required>
        <option value="">Выберите номер</option>
      </select>
    </div>
    <div class="form-group">
      <textarea id="comments" placeholder="Комментарий (необязательно)"></textarea>
    </div>
    <button type="submit">Забронировать</button>
    <div class="loader" id="loader">Загрузка...</div>
  </form>
</div>

<!-- Управление бронированием -->
<div id="manageForm" class="container" style="display:none;">
  <h2 style="text-align:center;">Управление бронированием</h2>
  <div class="form-group">
    <input type="text" id="searchBookingID" placeholder="Введите ID бронирования">
  </div>
  <button onclick="searchBooking()">Найти</button>
  <div id="foundBookingInfo" style="display:none; margin-top:15px; background:#f1f1f1; padding:15px; border-radius:8px;"></div>
  <div style="margin-top:15px;">
    <button onclick="goBackToBooking()" style="background:#ccc;">Назад к бронированию</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbyGYP3zAhRA8TmGqczGeydaItCdhk8eFjEw6FyYB0X0s6M6oc-k3s8n1SoQYd5JmeCt/exec';

function showLoader(show) {
  document.getElementById('loader').style.display = show ? 'block' : 'none';
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 3000);
}

function submitForm(event) {
  event.preventDefault();
  showLoader(true);

  const data = {
    action: 'book',
    full_name: document.getElementById('fullName').value,
    phone: document.getElementById('phone').value,
    email: document.getElementById('email').value,
    checkin: document.getElementById('checkin').value,
    checkout: document.getElementById('checkout').value,
    guests: document.getElementById('guests').value,
    room_type: document.getElementById('room_type').value,
    comments: document.getElementById('comments').value
  };

  fetch(API, {
    method: 'POST',
    body: JSON.stringify(data),
    mode: 'cors'
  })
  .then(r => r.json())
  .then(res => {
    showLoader(false);
    if (res.result === 'success') {
      showToast('Бронирование успешно! ID: ' + res.booking_id);
      document.querySelector('form').reset();
    } else {
      showToast('Ошибка: ' + res.message);
    }
  })
  .catch(() => {
    showLoader(false);
    showToast('Ошибка отправки.');
  });
}

function loadRooms() {
  const script = document.createElement('script');
  script.src = `${API}?action=rooms&callback=populateRooms`;
  document.body.appendChild(script);
}

function populateRooms(data) {
  const select = document.getElementById('room_type');
  data.rooms.forEach(room => {
    const option = document.createElement('option');
    option.value = room.name;
    option.textContent = room.name + ' — ' + room.description;
    select.appendChild(option);
  });
}

function openManageForm() {
  document.getElementById('bookingForm').style.display = 'none';
  document.getElementById('manageForm').style.display = 'block';
}

function goBackToBooking() {
  document.getElementById('manageForm').style.display = 'none';
  document.getElementById('bookingForm').style.display = 'block';
}

function searchBooking() {
  const id = document.getElementById('searchBookingID').value.trim();
  if (!id) {
    showToast('Введите ID для поиска.');
    return;
  }

  showLoader(true);
  fetch(`${API}?action=get&id=${encodeURIComponent(id)}`)
    .then(r => r.json())
    .then(data => {
      showLoader(false);
      const infoBlock = document.getElementById('foundBookingInfo');
      if (data && data.result === 'success' && data.booking) {
        const b = data.booking;
        infoBlock.innerHTML = `
          <p><strong>ФИО:</strong> ${b.full_name}</p>
          <p><strong>Телефон:</strong> ${b.phone}</p>
          <p><strong>Email:</strong> ${b.email}</p>
          <p><strong>Даты:</strong> ${b.checkin} — ${b.checkout}</p>
          <p><strong>Гости:</strong> ${b.guests}</p>
          <p><strong>Номер:</strong> ${b.room_type}</p>
          <p><strong>Комментарий:</strong> ${b.comments || '-'}</p>
          <button onclick="cancelBooking('${id}')" style="margin-top:10px; padding:10px; background:red; color:white; border:none; border-radius:8px;">
            Отменить бронирование
          </button>`;
        infoBlock.style.display = 'block';
      } else {
        infoBlock.innerHTML = '<p style="color:red;">Бронирование не найдено.</p>';
        infoBlock.style.display = 'block';
      }
    })
    .catch(err => {
      showLoader(false);
      showToast('Ошибка при поиске.');
      console.error(err);
    });
}

function cancelBooking(id) {
  if (!confirm('Вы уверены, что хотите отменить бронирование?')) return;
  showLoader(true);
  fetch(API, {
    method: 'POST',
    body: JSON.stringify({ action: 'cancel', booking_id: id }),
    mode: 'cors'
  })
  .then(r => r.json())
  .then(res => {
    showLoader(false);
    if (res.result === 'success') {
      showToast('Бронирование отменено.');
      document.getElementById('foundBookingInfo').innerHTML = '';
    } else {
      showToast('Ошибка отмены.');
    }
  })
  .catch(() => {
    showLoader(false);
    showToast('Ошибка отмены.');
  });
}

// Загрузка номеров при открытии страницы
window.onload = loadRooms;
</script>

</body>
</html>
