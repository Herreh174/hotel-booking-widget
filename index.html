<!DOCTYPE html>
<html lang="ru">
<head> … </head>
<body>
  <h2>Бронирование номера</h2>

  <label>Тип номера:
    <select id="room-type"></select>
  </label>

  <label>Даты:
    <input id="date-range" readonly/>
  </label>

  <div id="price">Итого: –</div>

  <label>
    <input type="checkbox" id="terms"/>
    Я принимаю условия
  </label>

  <button id="book-btn">Забронировать и оплатить</button>
  <div id="msg"></div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://checkout.yookassa.ru/v3/checkout.js"></script>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwbnCTrcN2LbEburkL9qebJdZGMoVkCK0xC9iS_e2hMG8OwyMzLXhZ8irdy92wKqy_F2Q/exec'; // тот же из Apps Script

    let roomTypes = [];
    let bookedDates = [];

    // 1) Подгружаем типы номеров
    fetch(`${SCRIPT_URL}?action=rooms`)
      .then(r => r.json())
      .then(rooms => {
        roomTypes = rooms;
        const sel = document.getElementById('room-type');
        rooms.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.rate;
          opt.text  = `${r.name} — ${r.rate}₽/ночь`;
          sel.add(opt);
        });
      });

    // 2) Подгружаем занятость
    fetch(`${SCRIPT_URL}?action=availability`)
      .then(r => r.json())
      .then(dates => {
        bookedDates = dates;
        initCalendar();
      });

    let fp;
    function initCalendar() {
      fp = flatpickr("#date-range", {
        mode: "range",
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: bookedDates,
        onChange: updatePrice
      });
    }

    function updatePrice(dates) {
      const priceEl = document.getElementById('price');
      if (dates.length < 2) return priceEl.innerText = "Итого: –";
      const nights = (dates[1] - dates[0])/(1000*60*60*24);
      const rate   = parseFloat(document.getElementById('room-type').value);
      priceEl.innerText = `Итого: ${rate * nights}₽ (${nights}×${rate}₽)`;
    }

    document.getElementById('room-type')
      .addEventListener('change', () => updatePrice(fp.selectedDates));

    // YooKassa init
    const checkout = new YooCheckout({
      shopId: 'ВАШ_SHOP_ID',
      checkoutUrl: 'ВАШ_CHECKOUT_URL'
    });

    document.getElementById('book-btn')
      .addEventListener('click', () => {
        const dates = fp.selectedDates;
        const email = prompt("Введите e-mail");
        const ok    = document.getElementById('terms').checked;
        if (!email || dates.length<2 || !ok)
          return alert("Заполните все поля и примите условия.");

        const [inD,outD] = dates.map(d => fp.formatDate(d, "Y-m-d"));
        const nights     = (dates[1]-dates[0])/(1000*60*60*24);
        const rate       = parseFloat(document.getElementById('room-type').value);
        const roomName   = document.getElementById('room-type')
                              .selectedOptions[0].text.split(' — ')[0];
        const total      = (rate * nights).toFixed(2);

        checkout.createPayment({
          amount: { value: total, currency: "RUB" },
          confirmation: { type: "embedded" },
          description: `Бронь ${roomName} ${inD}→${outD}`,
          metadata: { email, checkIn: inD, checkOut: outD }
        })
        .then(p => {
          if (p.status==='succeeded') {
            return fetch(SCRIPT_URL, {
              method: 'POST',
              body: JSON.stringify({
                action: 'book',
                email, checkIn: inD, checkOut: outD,
                roomName, price: total
              })
            });
          }
          throw new Error('Неуспешный статус: '+p.status);
        })
        .then(r=>r.json())
        .then(res=>{
          document.getElementById('msg')
            .innerText = `Готово! Ваш ID: ${res.id}`;
        })
        .catch(e=>alert("Ошибка: "+e.message));
      });
  </script>
</body>
</html>
