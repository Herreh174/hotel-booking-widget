<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Бронирование номера</title>
  <style>
    body { font-family: Arial,sans-serif; background:#f7f7f7; }
    .container { max-width:500px; margin:50px auto; padding:20px;
                 background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    label { display:block; margin-bottom:5px; color:#333; }
    select,input,textarea,button {
      width:100%; padding:8px; margin-bottom:15px;
      border:1px solid #ccc; border-radius:4px; box-sizing:border-box;
    }
    button { background:#28a745; color:#fff; border:none; cursor:pointer; }
    button:disabled { background:#ccc; cursor:not-allowed; }
    .error { color:red; margin-top:-10px; margin-bottom:10px; }
    #guestFields { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h2 style="text-align:center;">Бронирование номера</h2>

    <!-- Выбор комнаты и дат -->
    <label>Номер</label>
    <select id="room" disabled><option>Загрузка...</option></select>

    <label>Дата заезда</label>
    <input type="date" id="checkin"/>

    <label>Дата выезда</label>
    <input type="date" id="checkout"/>

    <div id="datesError" class="error"></div>

    <!-- Данные гостя -->
    <div id="guestFields">
      <label>ФИО</label><input id="full_name" type="text"/>
      <label>Телефон</label><input id="phone" type="tel"/>
      <label>Email</label><input id="email" type="email"/>
      <label>Комментарий</label><textarea id="comments"></textarea>
      <button id="submitBtn">Подтвердить бронь</button>
    </div>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbwckll7S9olOyNZioF9oCOnAdDaeaeNc3ECUH-3wuhoo2xWikTP6GUP1Qy_ncAp9fOp/exec'; // <-- вставьте URL веб-приложения

    async function getJSON(url) {
      const r = await fetch(url);
      return r.json();
    }

    async function loadRooms() {
      const data = await getJSON(`${API}?list_rooms=1`);
      const sel  = document.getElementById('room');
      sel.innerHTML = '';
      if (data.error) {
        sel.innerHTML = `<option>${data.error}</option>`;
      } else {
        data.rooms.forEach(r => {
          if (r.status === 'available' || r.status === '') {
            const o = document.createElement('option');
            o.value = r.room_id;
            o.textContent = `${r.room_name} — ${r.capacity} гостей — ${r.price}₽`;
            sel.appendChild(o);
          }
        });
      }
      sel.disabled = false;
      checkAvailability();
    }

    async function checkAvailability() {
      const room = document.getElementById('room').value;
      const ci   = document.getElementById('checkin').value;
      const co   = document.getElementById('checkout').value;
      const err  = document.getElementById('datesError');
      err.textContent = '';
      document.getElementById('guestFields').style.display = 'none';

      if (!room || !ci || !co) return;
      if (new Date(co) <= new Date(ci)) {
        err.textContent = 'Дата выезда должна быть позже даты заезда.';
        return;
      }

      const data = await getJSON(`${API}?room_id=${room}&start=${ci}&end=${co}`);
      if (data.error) {
        err.textContent = data.error;
      } else {
        const nights = (new Date(co) - new Date(ci)) / (1000*60*60*24);
        if (data.available_dates.length < nights) {
          err.textContent = 'Номер занят в некоторые из выбранных дат.';
        } else {
          document.getElementById('guestFields').style.display = 'block';
        }
      }
    }

    async function submitBooking() {
      const payload = {
        booking_id: 'N-' + (Math.random()*1e8|0),
        full_name:  document.getElementById('full_name').value,
        phone:      document.getElementById('phone').value,
        email:      document.getElementById('email').value,
        guests:     1,
        checkin:    document.getElementById('checkin').value,
        checkout:   document.getElementById('checkout').value,
        room_id:    document.getElementById('room').value,
        room_type:  document.getElementById('room').selectedOptions[0].textContent,
        total_price:'—',
        comments:   document.getElementById('comments').value
      };
      const res = await fetch(API, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.result === 'success') {
        alert('Бронирование успешно! ID: ' + data.booking_id);
        location.reload();
      } else {
        alert('Ошибка: ' + (data.error||'неизвестная'));
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const t  = new Date(), tm = new Date(t);
      tm.setDate(tm.getDate()+1);
      const min = tm.toISOString().split('T')[0];
      document.getElementById('checkin').min  = min;
      document.getElementById('checkout').min = min;

      document.getElementById('room').addEventListener('change', checkAvailability);
      document.getElementById('checkin').addEventListener('change', checkAvailability);
      document.getElementById('checkout').addEventListener('change', checkAvailability);
      document.getElementById('submitBtn').addEventListener('click', submitBooking);

      loadRooms();
    });
  </script>
</body>
</html>
