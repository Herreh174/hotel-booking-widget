<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Бронирование номеров</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    select, input, button {
      padding: 10px;
      margin-top: 10px;
      display: block;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h2>Выберите номер</h2>
  <select id="roomSelect">
    <option disabled selected>Загрузка...</option>
  </select>

  <div id="dateSection" class="hidden">
    <h3>Выберите даты</h3>
    <label>Заезд: <input type="date" id="checkin"></label>
    <label>Выезд: <input type="date" id="checkout"></label>
    <button id="checkAvailability">Проверить доступность</button>
  </div>

  <div id="guestForm" class="hidden">
    <h3>Информация о госте</h3>
    <label>Имя: <input type="text" id="guestName"></label>
    <label>Email: <input type="email" id="guestEmail"></label>
    <button id="bookRoom">Забронировать</button>
  </div>

  <div id="status"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyOEV4hw23bFCRqy75hiGad0TtA-r8Laff3gHWgH4qtcn_UBdcg5pHUGfYjxP7cLCZv/exec';

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("Network error");
      return await res.json();
    }

    async function loadRooms() {
      try {
        const data = await fetchJSON(`${API_URL}?list_rooms=1`);
        const select = document.getElementById("roomSelect");
        select.innerHTML = '<option disabled selected>Выберите номер</option>';
        data.rooms.forEach(room => {
          const option = document.createElement("option");
          option.value = room.id;
          option.textContent = room.name;
          select.appendChild(option);
        });
      } catch (e) {
        document.getElementById("status").textContent = "Ошибка загрузки номеров";
        console.error(e);
      }
    }

    document.getElementById("roomSelect").addEventListener("change", () => {
      document.getElementById("dateSection").classList.remove("hidden");
    });

    document.getElementById("checkAvailability").addEventListener("click", async () => {
      const roomId = document.getElementById("roomSelect").value;
      const checkin = document.getElementById("checkin").value;
      const checkout = document.getElementById("checkout").value;

      if (!checkin || !checkout) {
        alert("Введите даты");
        return;
      }

      try {
        const res = await fetchJSON(`${API_URL}?check_availability=1&room_id=${roomId}&checkin=${checkin}&checkout=${checkout}`);
        if (res.available) {
          document.getElementById("guestForm").classList.remove("hidden");
          document.getElementById("status").textContent = "Номер доступен!";
        } else {
          document.getElementById("guestForm").classList.add("hidden");
          document.getElementById("status").textContent = "Номер занят на выбранные даты.";
        }
      } catch (e) {
        document.getElementById("status").textContent = "Ошибка проверки";
      }
    });

    document.getElementById("bookRoom").addEventListener("click", async () => {
      const roomId = document.getElementById("roomSelect").value;
      const checkin = document.getElementById("checkin").value;
      const checkout = document.getElementById("checkout").value;
      const name = document.getElementById("guestName").value;
      const email = document.getElementById("guestEmail").value;

      try {
        const res = await fetchJSON(`${API_URL}?book_room=1&room_id=${roomId}&checkin=${checkin}&checkout=${checkout}&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`);
        if (res.success) {
          document.getElementById("status").textContent = "Бронирование успешно!";
        } else {
          document.getElementById("status").textContent = "Ошибка бронирования.";
        }
      } catch (e) {
        document.getElementById("status").textContent = "Ошибка сети.";
      }
    });

    // Загрузка комнат при запуске
    loadRooms();
  </script>
</body>
</html>
