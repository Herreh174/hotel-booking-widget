<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Бронирование номера</title>
  <style>
    /* Анимации и тосты */
    #bookingForm { animation: fadeIn 1s ease forwards; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);} }
    .toast { position:fixed;top:20px;right:20px;background:#FFD700;color:#333;
             padding:12px 20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.2);
             opacity:0;animation:slideDown 0.5s ease forwards;z-index:9999; }
    @keyframes slideDown { from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);} }
    /* Модалка */
    .modal { display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;
             background:rgba(0,0,0,0.5);justify-content:center;align-items:center;
             animation:fadeIn 0.4s forwards; }
    .modal-content{background:#fff;padding:30px 40px;border-radius:16px;text-align:center;
                    max-width:400px;transform:scale(0.8);opacity:0;animation:zoomIn 0.4s forwards;}
    .modal-icon{font-size:50px;color:#FFD700;margin-bottom:15px;}
    .modal-button{margin-top:20px;padding:10px 20px;background:#FFD700;border:none;border-radius:8px;
                  cursor:pointer;color:#333;font-weight:bold;transition:background .3s;}
    .modal-button:hover{background:#e6c200;}
    @keyframes zoomIn{from{transform:scale(0.8);opacity:0;}to{transform:scale(1);opacity:1;}}
    /* Контейнер и поля */
    .container{max-width:600px;margin:30px auto;padding:20px;background:#fff;border-radius:12px;
               box-shadow:0 0 20px rgba(0,0,0,0.05);font-family:'Helvetica Neue',Arial,sans-serif;}
    .container div{margin-bottom:15px;}
    .container label{display:block;margin-bottom:5px;color:#333;}
    .container input, .container select, .container textarea, .container button {
      width:100%;padding:10px;border:2px solid #FFD700;border-radius:8px;font-size:16px;
      box-sizing:border-box;
    }
    #guestFields { display: none; }
    #submitBtn{background:#FFD700;color:#333;font-weight:bold;cursor:pointer;transition:background .3s;}
    #submitBtn:hover:not([disabled]){background:#e6c200;}
  </style>
</head>
<body>
  <div class="container">
    <h2 style="text-align:center;color:#333;">Бронирование номера</h2>

    <!-- Шаг 1: выбор дат и номера -->
    <div id="selection">
      <div>
        <label for="checkin">Дата заезда</label>
        <input type="date" id="checkin" required>
      </div>
      <div>
        <label for="checkout">Дата выезда</label>
        <input type="date" id="checkout" required>
      </div>
      <div>
        <label for="room">Выберите номер</label>
        <select id="room" disabled>
          <option>Сначала выберите даты</option>
        </select>
      </div>
      <div id="datesError" style="color:red;"></div>
    </div>

    <!-- Шаг 2: ввод данных гостя -->
    <form id="bookingForm">
      <div id="guestFields">
        <div>
          <label for="full_name">ФИО</label>
          <input type="text" id="full_name" required placeholder="Иванов Иван">
        </div>
        <div>
          <label for="phone">Телефон</label>
          <input type="tel" id="phone" required placeholder="8-(999)-999-99-99">
        </div>
        <div>
          <label for="email">Email</label>
          <input type="email" id="email" required placeholder="email@example.com">
        </div>
        <div>
          <label for="comments">Пожелания по размещению</label>
          <textarea id="comments" placeholder="Например: нужна детская кроватка"></textarea>
        </div>
        <button id="submitBtn" type="submit">Подтвердить бронирование</button>
      </div>
    </form>
  </div>

  <div id="toastContainer"></div>
  <div id="successModal" class="modal">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-icon">✅</div>
      <h3>Спасибо за бронирование!</h3>
      <p>Ваш ID бронирования: <span id="bookingID"></span></p>
      <p>Мы скоро свяжемся с вами для подтверждения.</p>
      <button class="modal-button" onclick="closeModal()">Закрыть</button>
    </div>
  </div>

  <script>
    const API = 'ВАШ_API_URL_ОТ_APPS_SCRIPT';

    function showToast(msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerText = msg;
      document.getElementById('toastContainer').appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }
    function closeModal() {
      document.getElementById('successModal').style.display = 'none';
    }

    // Минимальные даты — с завтрашнего дня
    document.addEventListener('DOMContentLoaded', () => {
      const t = new Date(), tm = new Date(t);
      tm.setDate(tm.getDate()+1);
      const min = tm.toISOString().split('T')[0];
      document.getElementById('checkin').min = min;
      document.getElementById('checkout').min = min;
    });

    // Когда обе даты выбраны — загружаем комнаты
    function tryEnableRooms() {
      const ci = document.getElementById('checkin').value;
      const co = document.getElementById('checkout').value;
      const sel = document.getElementById('room');
      document.getElementById('guestFields').style.display = 'none';
      document.getElementById('datesError').textContent = '';
      if (!ci||!co) return;
      if (new Date(co) <= new Date(ci)) {
        showToast('Дата выезда должна быть позже даты заезда.');
        sel.innerHTML = '<option>Неверный диапазон</option>';
        sel.disabled = true;
        return;
      }
      // JSONP: список комнат
      const cb = 'displayRooms';
      const old = document.getElementById('jsonpRooms');
      if (old) old.remove();
      const s = document.createElement('script');
      s.src = `${API}?list_rooms=1&callback=${cb}`;
      s.id  = 'jsonpRooms';
      document.body.appendChild(s);
    }
    document.getElementById('checkin').addEventListener('change', tryEnableRooms);
    document.getElementById('checkout').addEventListener('change', tryEnableRooms);

    // Заполняем селект комнат
    function displayRooms(res) {
      const sel = document.getElementById('room');
      sel.innerHTML = '';
      if (res.error) {
        sel.innerHTML = `<option>${res.error}</option>`;
        sel.disabled = true;
        return;
      }
      res.rooms.forEach(r => {
        if (r.status === 'available' || r.status === '') {
          const o = document.createElement('option');
          o.value = r.room_id;
          o.textContent = `${r.room_name} — ${r.capacity} гостей — ${r.price} ₽/ночь`;
          sel.appendChild(o);
        }
      });
      sel.disabled = false;
    }

    // При выборе комнаты — проверяем её даты
    document.getElementById('room').addEventListener('change', () => {
      const ci = document.getElementById('checkin').value;
      const co = document.getElementById('checkout').value;
      const roomId = document.getElementById('room').value;
      if (!ci||!co||!roomId) return;
      const cb = 'displayAvailableDates';
      const old = document.getElementById('jsonpDates');
      if (old) old.remove();
      const s = document.createElement('script');
      s.id  = 'jsonpDates';
      s.src = `${API}?room_id=${roomId}&start=${ci}&end=${co}&callback=${cb}`;
      document.body.appendChild(s);
    });

    // Получили свободные даты — сравниваем с выбранным периодом
    function displayAvailableDates(res) {
      const ci = document.getElementById('checkin').value;
      const co = document.getElementById('checkout').value;
      const nights = (new Date(co) - new Date(ci)) / (1000*60*60*24);
      if (res.error) {
        document.getElementById('datesError').textContent = res.error;
        return;
      }
      if (res.available_dates.length < nights) {
        document.getElementById('datesError').textContent =
          'Номер занят в некоторые из выбранных дат.';
        return;
      }
      // Всё свободно — показываем форму гостя
      document.getElementById('datesError').textContent = '';
      document.getElementById('guestFields').style.display = 'block';
    }

    // Отправка бронирования
    document.getElementById('bookingForm').addEventListener('submit', e => {
      e.preventDefault();
      const data = {
        booking_id: 'N-' + (Math.floor(Math.random()*99999999)+1000),
        full_name:  document.getElementById('full_name').value,
        phone:      document.getElementById('phone').value,
        email:      document.getElementById('email').value,
        guests:     1,
        checkin:    document.getElementById('checkin').value,
        checkout:   document.getElementById('checkout').value,
        room_id:    document.getElementById('room').value,
        room_type:  document.getElementById('room').selectedOptions[0].textContent,
        total_price: '—',
        comments:   document.getElementById('comments').value
      };
      fetch(API, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(d => {
        if (d.result === 'success') {
          document.getElementById('bookingID').textContent = data.booking_id;
          document.getElementById('successModal').style.display = 'flex';
        } else {
          showToast('Ошибка бронирования: ' + (d.error||'неизвестная'));
        }
      })
      .catch(() => showToast('Сетевая ошибка при отправке.'));
    });
  </script>
</body>
</html>
